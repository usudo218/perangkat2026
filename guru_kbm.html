<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JURNAL KBM GURU - SMAN 1 MUNCAR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 60px; color: #333; }
        
        /* Floating Back Button */
        .btn-float { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; padding: 12px 25px; border-radius: 50px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 999; transition: 0.3s; }
        .btn-float:hover { background: #1d4ed8; transform: translateY(-2px); }

        .container { max-width: 1200px; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 20px; width: 95%; }
        
        .header { background: #1e293b; color: white; padding: 20px; border-radius: 8px 8px 0 0; margin: -20px -20px 20px -20px; text-align: center; }
        .header h1 { margin: 0; font-size: 1.5rem; } .header p { margin: 5px 0 0; opacity: 0.8; font-size: 0.9rem; }

        /* Controls */
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        select, input[type=date] { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .btn { padding: 8px 15px; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .btn-blue { background: #3b82f6; } .btn-green { background: #10b981; } .btn-red { background: #ef4444; } .btn-gray { background: #64748b; }

        /* Tabs */
        .tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { padding: 12px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: #64748b; white-space: nowrap; }
        .tab-btn.active { border-color: var(--primary); color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Tables */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 600px; }
        th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: center; }
        th { background: #f1f5f9; color: #334155; }
        td { text-align: left; }
        td.center { text-align: center; }
        
        /* Status Colors */
        .bg-h { background: #dcfce7; color: #166534; } .bg-s { background: #fef9c3; color: #854d0e; } 
        .bg-i { background: #dbeafe; color: #1e40af; } .bg-a { background: #fee2e2; color: #991b1b; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #475569; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }

        /* Print Style */
        @media print {
            .btn-float, .controls, .tabs, .header, .no-print { display: none !important; }
            .container { box-shadow: none; max-width: 100%; margin: 0; padding: 0; }
            table { border: 2px solid black; } th, td { border: 1px solid black; }
            .print-header { display: block !important; text-align: center; margin-bottom: 20px; }
            .print-footer { display: block !important; margin-top: 40px; text-align: right; }
        }
        .print-header, .print-footer { display: none; }
    </style>
</head>
<body>

<a href="guru_dashboard.html" class="btn-float">‚¨ÖÔ∏è Menu Utama</a>

<div class="container">
    <div class="header">
        <h1>PANEL KBM GURU</h1>
        <p>Manajemen Presensi, Jurnal, dan Nilai</p>
    </div>

    <div class="controls">
        <label>üìÇ Kelas:</label>
        <select id="pilih-kelas" onchange="gantiKelas()"><option value="">-- Pilih --</option></select>
        <button class="btn btn-gray" onclick="paksaReloadSiswa()">üîÑ Reload Data Siswa</button>
        <div style="flex-grow:1; text-align:right;">
            <button class="btn btn-blue" onclick="syncData('up')">‚òÅÔ∏è Simpan ke Cloud</button>
            <button class="btn btn-green" onclick="syncData('down')">‚¨áÔ∏è Ambil dari Cloud</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="bukaTab('presensi')">üìÖ Presensi</button>
        <button class="tab-btn" onclick="bukaTab('jurnal')">üìñ Jurnal Mengajar</button>
        <button class="tab-btn" onclick="bukaTab('nilai')">üìù Input Nilai</button>
        <button class="tab-btn" onclick="bukaTab('rekap')">üìä Rekapitulasi</button>
        <button class="tab-btn" onclick="bukaTab('setting')">‚öôÔ∏è Pengaturan</button>
    </div>

    <div id="tab-presensi" class="tab-content active">
        <div class="controls no-print">
            <input type="date" id="tgl-harian" onchange="gantiKelas()">
            <label>Pertemuan Ke:</label>
            <select id="pertemuan-ke" onchange="simpanMeta()">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
            </select>
        </div>
        <div class="table-wrap">
            <table id="tabel-presensi">
                <thead><tr><th width="50">No</th><th>Nama Siswa</th><th width="150">Status</th><th width="100">Ket</th></tr></thead>
                <tbody id="body-presensi"><tr><td colspan="4" class="center">Pilih Kelas Dahulu</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="tab-jurnal" class="tab-content">
        <div class="form-group"><label>Topik / Materi:</label><textarea id="j-materi" rows="2" onchange="simpanJurnal()"></textarea></div>
        <div class="form-group"><label>Metode / Aktivitas:</label><input type="text" id="j-aktivitas" onchange="simpanJurnal()"></div>
        <div class="form-group"><label>Catatan / Kendala:</label><textarea id="j-catatan" rows="2" onchange="simpanJurnal()"></textarea></div>
        <small style="color:green" id="msg-jurnal"></small>
    </div>

    <div id="tab-nilai" class="tab-content">
        <div class="table-wrap">
            <table>
                <thead>
                    <tr><th rowspan="2">No</th><th rowspan="2">Nama</th><th colspan="5">Tugas</th><th colspan="2">UH</th><th rowspan="2">Rata2</th></tr>
                    <tr><th>T1</th><th>T2</th><th>T3</th><th>T4</th><th>T5</th><th>UH1</th><th>UH2</th></tr>
                </thead>
                <tbody id="body-nilai"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-rekap" class="tab-content">
        <div class="controls no-print">
            <button class="btn btn-green" onclick="exportExcel()">üì• Download Excel</button>
            <button class="btn btn-blue" onclick="window.print()">üñ® Cetak Laporan</button>
        </div>
        
        <div class="print-header">
            <h3>REKAPITULASI KEHADIRAN SISWA</h3>
            <p>Kelas: <span id="print-kelas">-</span> | Tanggal Cetak: <span id="print-tgl">-</span></p>
        </div>

        <div class="table-wrap">
            <table id="tabel-rekap">
                <thead><tr><th>No</th><th>Nama</th><th>H</th><th>S</th><th>I</th><th>A</th><th>% Hadir</th></tr></thead>
                <tbody id="body-rekap"></tbody>
            </table>
        </div>

        <div class="print-footer">
    <p>Muncar, <span id="sign-tgl"></span><br>Guru Mata Pelajaran</p>
    <br><br><br>
    <p>
        <strong><u>Agus Suyatno, S.Kom</u></strong><br>
        NIP. 19720213 202521 1 032
    </p>
</div>
    </div>

    <div id="tab-setting" class="tab-content">
        <h3>Manajemen Data</h3>
        <p>Gunakan fitur ini jika ingin mereset data lokal di browser ini.</p>
        <button class="btn btn-red" onclick="resetAll()">‚ö†Ô∏è Hapus Semua Data (Reset)</button>
    </div>
</div>

<script src="siswa.js"></script>
<script>
    // ‚öôÔ∏è KONFIGURASI GOOGLE SCRIPT (PASTIKAN BENAR)
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyWEwycE3YMZyUqLS_Dsx6jMMF9WNbu1TCC7QG48N02-nXI76K6idu41gOrPY4Y7wh7/exec";

    // Global State
    let dataSiswa = JSON.parse(localStorage.getItem('db_siswa')) || [];
    let dbAbsen = JSON.parse(localStorage.getItem('db_absen')) || {};
    let dbJurnal = JSON.parse(localStorage.getItem('db_jurnal')) || {};
    let dbMeta = JSON.parse(localStorage.getItem('db_meta')) || {}; // Untuk simpan pertemuan ke-
    let curKelas = localStorage.getItem('last_kelas') || "";

    // Init
    document.getElementById('tgl-harian').valueAsDate = new Date();
    document.getElementById('sign-tgl').innerText = new Date().toLocaleDateString('id-ID');
    document.getElementById('print-tgl').innerText = new Date().toLocaleDateString('id-ID');
    
    // Cek Data Awal
    if(dataSiswa.length === 0 && typeof SISWA_BARU !== 'undefined') { paksaReloadSiswa(false); }
    else { initUI(); }

    function initUI() {
        const sel = document.getElementById('pilih-kelas');
        sel.innerHTML = '<option value="">-- Pilih Kelas --</option>';
        let list = [...new Set(dataSiswa.map(s => s.kelas))].sort();
        list.forEach(k => sel.innerHTML += `<option value="${k}">${k}</option>`);
        if(curKelas && list.includes(curKelas)) { sel.value = curKelas; gantiKelas(); }
    }

    function gantiKelas() {
        curKelas = document.getElementById('pilih-kelas').value;
        localStorage.setItem('last_kelas', curKelas);
        document.getElementById('print-kelas').innerText = curKelas;
        
        if(!curKelas) return;
        renderPresensi(); renderNilai(); renderRekap(); loadJurnalForm();
    }

    function bukaTab(id) {
        document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        event.target.classList.add('active');
    }

    // --- LOGIC PRESENSI ---
    function renderPresensi() {
        const tgl = document.getElementById('tgl-harian').value;
        const list = dataSiswa.filter(s => s.kelas === curKelas);
        const absenData = dbAbsen[tgl] || {};
        
        let html = "";
        list.forEach((s, i) => {
            const st = absenData[s.id] || "";
            let cls = st==='H'?'bg-h': st==='S'?'bg-s': st==='I'?'bg-i': st==='A'?'bg-a':'';
            html += `<tr>
                <td class="center">${i+1}</td>
                <td>${s.nama}</td>
                <td class="${cls}">
                    <select onchange="simpanAbsen('${s.id}', this.value)" style="width:100%">
                        <option value="">-</option>
                        <option value="H" ${st==='H'?'selected':''}>Hadir</option>
                        <option value="S" ${st==='S'?'selected':''}>Sakit</option>
                        <option value="I" ${st==='I'?'selected':''}>Izin</option>
                        <option value="A" ${st==='A'?'selected':''}>Alpha</option>
                    </select>
                </td>
                <td class="center"><strong>${st}</strong></td>
            </tr>`;
        });
        document.getElementById('body-presensi').innerHTML = html;
        
        // Load pertemuan ke-
        const key = curKelas + "_" + tgl;
        if(dbMeta[key]) document.getElementById('pertemuan-ke').value = dbMeta[key];
    }

    function simpanAbsen(id, val) {
        const tgl = document.getElementById('tgl-harian').value;
        if(!dbAbsen[tgl]) dbAbsen[tgl] = {};
        dbAbsen[tgl][id] = val;
        localStorage.setItem('db_absen', JSON.stringify(dbAbsen));
        renderPresensi(); renderRekap(); // Update warna & rekap
    }
    
    function simpanMeta() {
        const tgl = document.getElementById('tgl-harian').value;
        dbMeta[curKelas + "_" + tgl] = document.getElementById('pertemuan-ke').value;
        localStorage.setItem('db_meta', JSON.stringify(dbMeta));
    }

    // --- LOGIC JURNAL ---
    function loadJurnalForm() {
        const tgl = document.getElementById('tgl-harian').value;
        const data = dbJurnal[curKelas+"_"+tgl] || {m:'', a:'', c:''};
        document.getElementById('j-materi').value = data.m;
        document.getElementById('j-aktivitas').value = data.a;
        document.getElementById('j-catatan').value = data.c;
    }

    function simpanJurnal() {
        const tgl = document.getElementById('tgl-harian').value;
        dbJurnal[curKelas+"_"+tgl] = {
            m: document.getElementById('j-materi').value,
            a: document.getElementById('j-aktivitas').value,
            c: document.getElementById('j-catatan').value
        };
        localStorage.setItem('db_jurnal', JSON.stringify(dbJurnal));
        document.getElementById('msg-jurnal').innerText = "Tersimpan...";
        setTimeout(() => document.getElementById('msg-jurnal').innerText="", 2000);
    }

    // --- LOGIC NILAI ---
    function renderNilai() {
        const list = dataSiswa.filter(s => s.kelas === curKelas);
        let html = "";
        list.forEach((s, i) => {
            if(!s.n) s.n = {t1:0,t2:0,t3:0,t4:0,t5:0,uh1:0,uh2:0};
            const avg = ((s.n.t1+s.n.t2+s.n.t3+s.n.t4+s.n.t5+s.n.uh1+s.n.uh2)/7).toFixed(0);
            html += `<tr>
                <td class="center">${i+1}</td> <td>${s.nama}</td>
                ${['t1','t2','t3','t4','t5','uh1','uh2'].map(k => 
                    `<td><input type="number" style="width:40px; text-align:center" value="${s.n[k]}" 
                    onchange="saveNilai('${s.id}','${k}',this.value)"></td>`
                ).join('')}
                <td class="center"><b>${avg}</b></td>
            </tr>`;
        });
        document.getElementById('body-nilai').innerHTML = html;
    }

    function saveNilai(id, key, val) {
        const s = dataSiswa.find(x => x.id === id);
        if(s) {
            s.n[key] = parseInt(val) || 0;
            localStorage.setItem('db_siswa', JSON.stringify(dataSiswa));
            renderNilai();
        }
    }

    // --- LOGIC REKAP ---
    function renderRekap() {
        const list = dataSiswa.filter(s => s.kelas === curKelas);
        let html = "";
        list.forEach((s, i) => {
            let h=0, sk=0, iz=0, al=0, total=0;
            Object.values(dbAbsen).forEach(dayData => {
                const st = dayData[s.id];
                if(st==='H') h++; if(st==='S') sk++; if(st==='I') iz++; if(st==='A') al++;
                if(st) total++;
            });
            const persentase = total > 0 ? Math.round((h/total)*100) : 0;
            html += `<tr><td class="center">${i+1}</td><td>${s.nama}</td><td class="center">${h}</td><td class="center">${sk}</td><td class="center">${iz}</td><td class="center" style="color:red">${al}</td><td class="center">${persentase}%</td></tr>`;
        });
        document.getElementById('body-rekap').innerHTML = html;
    }

    // --- SYSTEM UTILS ---
    function paksaReloadSiswa(alertUser=true) {
        if(typeof SISWA_BARU === 'undefined') return alert("Gagal baca siswa.js");
        dataSiswa = SISWA_BARU.map(m => {
            // Cek apakah siswa sudah ada, jika ada pertahankan nilainya
            const exist = dataSiswa.find(old => old.nama === m.nama && old.kelas === m.kelas);
            return exist ? exist : { id: 'S'+Date.now()+Math.floor(Math.random()*999), nama: m.nama, kelas: m.kelas, n: {t1:0,t2:0,t3:0,t4:0,t5:0,uh1:0,uh2:0} };
        });
        localStorage.setItem('db_siswa', JSON.stringify(dataSiswa));
        if(alertUser) alert("Data siswa berhasil direfresh!");
        location.reload();
    }

    function syncData(mode) {
        const btn = event.target; 
        const txt = btn.innerText; btn.innerText = "‚è≥ Proses..."; btn.disabled = true;

        if(mode === 'up') {
            fetch(APPS_SCRIPT_URL, {
                method: 'POST', body: JSON.stringify({ action: 'simpan_db', data: { siswa: dataSiswa, absen: dbAbsen, jurnal: dbJurnal, meta: dbMeta } })
            }).then(r=>r.json()).then(d => { alert("‚úÖ Upload Berhasil!"); btn.innerText = txt; btn.disabled = false; })
            .catch(e => { alert("‚ùå Gagal Upload."); btn.innerText = txt; btn.disabled = false; });
        } else {
            fetch(APPS_SCRIPT_URL + "?action=ambil_db")
            .then(r=>r.json()).then(d => {
                if(d.siswa) {
                    dataSiswa = d.siswa; dbAbsen = d.absen||{}; dbJurnal = d.jurnal||{}; dbMeta = d.meta||{};
                    localStorage.setItem('db_siswa', JSON.stringify(dataSiswa));
                    localStorage.setItem('db_absen', JSON.stringify(dbAbsen));
                    localStorage.setItem('db_jurnal', JSON.stringify(dbJurnal));
                    localStorage.setItem('db_meta', JSON.stringify(dbMeta));
                    alert("‚úÖ Download Berhasil! Halaman akan dimuat ulang.");
                    location.reload();
                } else { alert("Data di cloud kosong."); btn.innerText = txt; btn.disabled = false; }
            }).catch(e => { alert("‚ùå Gagal Download."); btn.innerText = txt; btn.disabled = false; });
        }
    }

    function resetAll() {
        if(confirm("Yakin hapus semua data di browser ini?")) { localStorage.clear(); location.reload(); }
    }
    
    function exportExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById('tabel-rekap'), {sheet:"Rekap"});
        XLSX.writeFile(wb, `Rekap_${curKelas}.xlsx`);
    }
</script>
</body>
</html>


